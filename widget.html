<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Widget RadioBOSS</title>

  <style>
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      color:#e5e7eb;
      background: transparent;
    }
    .wrap{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px;
    }
    .card{
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      background: rgba(2,6,23,.55);
      padding:12px;
    }
    .label{
      font-size:11px;
      opacity:.75;
      letter-spacing:.6px;
      text-transform: uppercase;
      margin-bottom:10px;
      font-weight:900;
    }

    /* Monitoreo: ocultar carátulas / miniaturas (pero dejamos el HTML porque RadioBOSS lo necesita) */
    .rbcloud_nowplaying a,
    .rbcloud_nowplaying img,
    .rbcloud_recent_track_cover{
      display:none !important;
    }

    /* Now playing */
    [id^="rbcloud_np_a"]{
      font-weight:900 !important;
      font-size:14px !important;
      line-height:1.15 !important;
    }
    [id^="rbcloud_np_t"]{
      font-size:13px !important;
      opacity:.95 !important;
      line-height:1.15 !important;
      margin-top:2px;
    }

    /* Recent list */
    .rbcloud_recenttracks .rbcloud_recent_track{
      display:block !important;
      margin:0 !important;
      padding:6px 0 !important;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .rbcloud_recenttracks .rbcloud_recent_track:last-child{ border-bottom:0; }

    .rbcloud_recent_artist{
      font-weight:900 !important;
      font-size:12px !important;
      line-height:1.15 !important;
    }
    .rbcloud_recent_title{
      font-size:12px !important;
      opacity:.92 !important;
      line-height:1.15 !important;
      margin-top:2px;
    }

    .status{
      margin-top:8px;
      font-size:12px;
      opacity:.7;
    }
    .status.err{ opacity:1; color:#fecaca; }

    .error{
      font-size:12px;
      color:#fecaca;
      padding:10px;
      border:1px solid rgba(239,68,68,.35);
      border-radius:10px;
      background: rgba(239,68,68,.12);
      white-space: pre-wrap;
      margin-top:10px;
    }

    .debug{
      margin-top:8px;
      font-size:11px;
      opacity:.7;
      line-height:1.25;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="label">Ahora sonando</div>
      <div id="nowMount"></div>
      <div id="np_status" class="status">Inicializando…</div>
      <div id="np_debug" class="debug"></div>
      <div id="np_error" class="error" style="display:none"></div>
    </div>

    <div class="card">
      <div class="label">Recientes (10)</div>
      <div id="recentMount"></div>
      <div id="rt_status" class="status">Inicializando…</div>
      <div id="rt_debug" class="debug"></div>
      <div id="rt_error" class="error" style="display:none"></div>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const id = (qs.get("id") || "").trim();
    const cb = (qs.get("cb") || "0").trim(); // cache buster: 1 = ON

    const npStatus = document.getElementById("np_status");
    const rtStatus = document.getElementById("rt_status");
    const npDebug  = document.getElementById("np_debug");
    const rtDebug  = document.getElementById("rt_debug");
    const npError  = document.getElementById("np_error");
    const rtError  = document.getElementById("rt_error");

    function showErr(el, msg){
      el.style.display = "block";
      el.textContent = msg;
    }
    function setErrStatus(el, msg){
      el.textContent = msg;
      el.classList.add("err");
    }

    // Normaliza por si algún link viene pegado con &amp;
    function normalizeUrl(u){
      return String(u || "").replaceAll("&amp;", "&");
    }

    function injectScript(src){
      src = normalizeUrl(src);

      if(cb === "1"){
        const join = src.includes("?") ? "&" : "?";
        src = src + join + "_cb=" + Date.now();
      }

      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = resolve;
        s.onerror = () => reject(new Error("No se pudo cargar: " + src));
        document.body.appendChild(s);
      });
    }

    async function main(){
      if(!id){
        showErr(npError, "Falta ?id= en la URL. Ej: widget.html?id=pepe-ganga");
        showErr(rtError, "Falta ?id= en la URL. Ej: widget.html?id=pepe-ganga");
        setErrStatus(npStatus, "Sin configuración");
        setErrStatus(rtStatus, "Sin configuración");
        return;
      }

      let channels;
      try{
        const r = await fetch("./channels.json", { cache: "no-store" });
        channels = await r.json();
      }catch(e){
        showErr(npError, "No se pudo leer channels.json");
        showErr(rtError, "No se pudo leer channels.json");
        setErrStatus(npStatus, "Error");
        setErrStatus(rtStatus, "Error");
        return;
      }

      const ch = (Array.isArray(channels) ? channels : []).find(x => String(x.id||"") === id);
      if(!ch || !ch.rb || !ch.rb.now || !ch.rb.recent){
        showErr(npError, "No existe configuración completa (rb.now / rb.recent) para id=" + id);
        showErr(rtError, "No existe configuración completa (rb.now / rb.recent) para id=" + id);
        setErrStatus(npStatus, "Sin configuración");
        setErrStatus(rtStatus, "Sin configuración");
        return;
      }

      // Datos RB
      const nowWid = ch.rb.now.wid;
      const nowArtwork = normalizeUrl(ch.rb.now.artwork);
      const nowScript  = normalizeUrl(ch.rb.now.script);

      const recentWid   = ch.rb.recent.wid;
      const recentCount = Number(ch.rb.recent.count || 10);
      const recentSize  = Number(ch.rb.recent.coverSize ?? 0);
      const recentScript = normalizeUrl(ch.rb.recent.script);

      // Render NOW (estructura exacta: IDs con wid)
      document.getElementById("nowMount").innerHTML = `
        <div class="rbcloud_nowplaying" style="display:flex;align-items:center;">
          <div>
            <a target="_blank" href="${nowArtwork}">
              <img id="rbcloud_np_c${nowWid}" src="${nowArtwork}" width="65" height="65" alt="cover art">
            </a>
          </div>
          <div style="margin-left:5pt;">
            <div id="rbcloud_np_a${nowWid}" style="font-weight:bold"></div>
            <div id="rbcloud_np_t${nowWid}">...</div>
          </div>
        </div>
      `;

      // Render RECENT (estructura exacta: id=rbcloud_recent{wid})
      document.getElementById("recentMount").innerHTML = `
        <div class="rbcloud_recenttracks" id="rbcloud_recent${recentWid}" data-cnt="${recentCount}">
          <div class="rbcloud_recent_track" style="display:flex;align-items:center;margin-bottom:5pt;">
            <div class="rbcloud_recent_track_cover" data-size="${recentSize}"></div>
            <div style="margin-left:5pt;">
              <div class="rbcloud_recent_artist" style="font-weight:bold"></div>
              <div class="rbcloud_recent_title">...</div>
            </div>
          </div>
        </div>
      `;

      npStatus.textContent = "Cargando Now Playing…";
      rtStatus.textContent = "Cargando Recientes…";
      npDebug.textContent = `id=${ch.id} | widNow=${nowWid}\n${nowScript}`;
      rtDebug.textContent = `widRecent=${recentWid} | cnt=${recentCount}\n${recentScript}`;

      // Inyectar scripts (exactos del proveedor)
      try{
        await injectScript(nowScript);
      }catch(e){
        setErrStatus(npStatus, "Error cargando NowPlaying");
        showErr(npError, e.message);
        return;
      }

      try{
        await injectScript(recentScript);
      }catch(e){
        setErrStatus(rtStatus, "Error cargando Recientes");
        showErr(rtError, e.message);
        // no retornamos: puede que Now sí esté ok
      }

      // Validación (espera a que RadioBOSS pinte datos)
      setTimeout(() => {
        const a = (document.getElementById(`rbcloud_np_a${nowWid}`)?.textContent || "").trim();
        const t = (document.getElementById(`rbcloud_np_t${nowWid}`)?.textContent || "").trim();

        if(a || (t && t !== "...")){
          npStatus.textContent = "OK";
        } else {
          setErrStatus(npStatus, "Sin datos (NOW)");
          showErr(npError, "RadioBOSS no pintó NowPlaying. Verifica que widNow y el script correspondan al mismo canal.\n" + nowScript);
        }

        const box = document.getElementById(`rbcloud_recent${recentWid}`);
        const n = box ? box.querySelectorAll(".rbcloud_recent_track").length : 0;

        if(n > 1){
          rtStatus.textContent = "OK";
        } else {
          setErrStatus(rtStatus, "Sin datos (RECENT)");
          showErr(rtError, "RadioBOSS no pintó Recientes. Verifica widRecent y script.\n" + recentScript);
        }
      }, 6500);
    }

    main();
  </script>
</body>
</html>
