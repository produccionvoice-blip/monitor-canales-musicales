<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RadioBOSS Widget</title>
  <style>
    :root{
      --bg: transparent;
      --text: #e5e7eb;
      --muted: rgba(229,231,235,.70);
      --line: rgba(255,255,255,.10);
      --box: rgba(2,6,23,.55);
      --box2: rgba(2,6,23,.35);
      --danger: rgba(239,68,68,.20);
      --dangerLine: rgba(239,68,68,.45);
    }

    html, body { margin:0; padding:0; background: var(--bg); color: var(--text); font-family: Arial, Helvetica, sans-serif; }

    .wrap { padding: 10px; display:flex; flex-direction:column; gap: 10px; }

    .panel {
      background: var(--box);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
    }

    .title {
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .8px;
      color: var(--muted);
      margin: 0 0 8px;
      text-transform: uppercase;
    }

    /* Now playing text (IDs are from RadioBOSS) */
    .npArtist { font-size: 15px; font-weight: 800; line-height: 1.2; margin-bottom: 4px; }
    .npTitle  { font-size: 14px; opacity: .95; line-height: 1.2; }

    /* Hide cover art for monitoring */
    .rbcloud_nowplaying img { display:none !important; }
    .rbcloud_recent_track_cover { display:none !important; }

    /* Recent list styling */
    .rbcloud_recenttracks { display: flex; flex-direction: column; gap: 8px; }
    .rbcloud_recent_track {
      background: var(--box2);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      margin: 0 !important;
    }
    .rbcloud_recent_artist { font-weight: 800; font-size: 13px; line-height: 1.2; }
    .rbcloud_recent_title  { font-size: 13px; opacity: .95; line-height: 1.2; }

    .hint { margin-top: 8px; font-size: 12px; color: var(--muted); }

    .err {
      margin-top: 10px;
      background: var(--danger);
      border: 1px solid var(--dangerLine);
      border-radius: 10px;
      padding: 10px;
      font-size: 12px;
      line-height: 1.35;
      display:none;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel" id="nowPanel">
      <div class="title">Ahora sonando</div>

      <!-- RadioBOSS NowPlaying skeleton (must exist BEFORE script runs) -->
      <div class="rbcloud_nowplaying" style="display:flex; align-items:flex-start;">
        <div>
          <a id="npArtLink" target="_blank">
            <img id="npCover" alt="cover art">
          </a>
        </div>

        <div style="margin-left: 0;">
          <div id="npArtist" class="npArtist"></div>
          <div id="npTitle" class="npTitle">Cargando...</div>
        </div>
      </div>

      <div class="err" id="errNow"></div>
    </div>

    <div class="panel" id="recentPanel">
      <div class="title" id="recentTitle">Recientes (10)</div>

      <!-- RadioBOSS RecentTracks skeleton (must exist BEFORE script runs) -->
      <div class="rbcloud_recenttracks" id="recentRoot" data-cnt="10">
        <div class="rbcloud_recent_track" style="display:flex; align-items:center;">
          <div class="rbcloud_recent_track_cover" data-size="0"></div>
          <div style="margin-left: 0;">
            <div class="rbcloud_recent_artist"></div>
            <div class="rbcloud_recent_title">...</div>
          </div>
        </div>
      </div>

      <div class="err" id="errRecent"></div>
    </div>
  </div>

  <script>
    function getParam(name, fallback = "") {
      const v = new URLSearchParams(location.search).get(name);
      return (v === null || v === undefined || v === "") ? fallback : v;
    }

    function normalizeHost(h) {
      if (!h) return "";
      if (h.startsWith("http://") || h.startsWith("https://")) return h.replace(/\/+$/,"");
      return ("https://" + h).replace(/\/+$/,"");
    }

    function injectScript(src, onError) {
      const s = document.createElement("script");
      s.src = src;
      s.async = true;
      s.onerror = () => onError && onError("No se pudo cargar: " + src);
      document.body.appendChild(s);
      return s;
    }

    // Read params
    const host = normalizeHost(getParam("host"));
    const u = getParam("u");
    const widNow = getParam("widNow");
    const widRecent = getParam("widRecent");
    const tf = getParam("tf", "0") === "1";
    const cnt = parseInt(getParam("cnt", "10"), 10) || 10;
    const coverSize = parseInt(getParam("coverSize", "0"), 10) || 0;

    const errNow = document.getElementById("errNow");
    const errRecent = document.getElementById("errRecent");

    if (!host || !u || !widNow || !widRecent) {
      errNow.style.display = "block";
      errNow.textContent = "Faltan par치metros. Requiere host, u, widNow, widRecent.";
      errRecent.style.display = "block";
      errRecent.textContent = "Faltan par치metros. Requiere host, u, widNow, widRecent.";
      throw new Error("Missing params");
    }

    // Build exact IDs RadioBOSS expects
    // NowPlaying expects: rbcloud_np_c{wid}, rbcloud_np_a{wid}, rbcloud_np_t{wid}
    const artworkUrl = `${host}/w/artwork/${u}.jpg`;

    // cover
    const npCover = document.getElementById("npCover");
    const npArtLink = document.getElementById("npArtLink");
    npCover.id = `rbcloud_np_c${widNow}`;
    npCover.src = artworkUrl;
    npCover.width = coverSize > 0 ? coverSize : 0;
    npCover.height = coverSize > 0 ? coverSize : 0;
    npArtLink.href = artworkUrl;

    // artist + title
    const npArtist = document.getElementById("npArtist");
    const npTitle = document.getElementById("npTitle");
    npArtist.id = `rbcloud_np_a${widNow}`;
    npTitle.id  = `rbcloud_np_t${widNow}`;

    // Recent expects: container id rbcloud_recent{widRecent} and template inside
    const recentRoot = document.getElementById("recentRoot");
    recentRoot.id = `rbcloud_recent${widRecent}`;
    recentRoot.setAttribute("data-cnt", String(cnt));
    document.getElementById("recentTitle").textContent = `Recientes (${cnt})`;

    // Set cover size (even if we hide it, keep it consistent with provider)
    const coverDiv = recentRoot.querySelector(".rbcloud_recent_track_cover");
    if (coverDiv) coverDiv.setAttribute("data-size", String(coverSize));

    // Load scripts (MUST be real <script> elements)
    const nowUrl =
      `${host}/w/nowplaying2.js?u=${encodeURIComponent(u)}&wid=${encodeURIComponent(widNow)}` +
      (tf ? "&tf=1" : "");

    const recentUrl =
      `${host}/w/recent.js?u=${encodeURIComponent(u)}&wid=${encodeURIComponent(widRecent)}&v=2` +
      (tf ? "&tf=1" : "");

    injectScript(nowUrl, (msg) => {
      errNow.style.display = "block";
      errNow.textContent = msg;
    });

    injectScript(recentUrl, (msg) => {
      errRecent.style.display = "block";
      errRecent.textContent = msg;
    });

    // Optional: simple watchdog (only after some time)
    setTimeout(() => {
      const a = document.getElementById(`rbcloud_np_a${widNow}`);
      const t = document.getElementById(`rbcloud_np_t${widNow}`);

      const nowOk = a && t && (a.textContent || "").trim().length > 0 && (t.textContent || "").trim().length > 0 && (t.textContent || "").trim() !== "...";
      if (!nowOk) {
        errNow.style.display = "block";
        errNow.textContent =
          "RadioBOSS no pint칩 NowPlaying.\n" +
          "Verifica que (host/u/widNow/tf) correspondan al mismo canal.\n" +
          nowUrl;
      }

      // Recent: expect more than the template line to be filled
      const titles = Array.from(document.querySelectorAll(`#rbcloud_recent${widRecent} .rbcloud_recent_title`))
        .map(x => (x.textContent || "").trim())
        .filter(x => x && x !== "..." );
      if (titles.length === 0) {
        errRecent.style.display = "block";
        errRecent.textContent =
          "RadioBOSS no pint칩 Recientes.\n" +
          "Verifica (host/u/widRecent/tf) y que el canal tenga historial disponible.\n" +
          recentUrl;
      }
    }, 9000);
  </script>
</body>
</html>
