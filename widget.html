<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RadioBOSS Monitor Widget</title>

  <style>
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      color:#e5e7eb;
      background: transparent;
    }

    .wrap{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px;
    }

    .card{
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      background: rgba(255,255,255,.04);
      padding:12px;
    }

    .label{
      font-size:11px;
      opacity:.75;
      letter-spacing:.6px;
      text-transform: uppercase;
      margin-bottom:10px;
      font-weight:900;
    }

    /* Monitoreo: ocultar carátulas */
    .rbcloud_nowplaying a,
    .rbcloud_nowplaying img,
    .rbcloud_recent_track_cover{
      display:none !important;
    }

    /* Now Playing: tipografía */
    [id^="rbcloud_np_a"]{
      font-weight:900 !important;
      font-size:14px !important;
      line-height:1.15 !important;
    }
    [id^="rbcloud_np_t"]{
      font-size:13px !important;
      opacity:.95 !important;
      line-height:1.15 !important;
    }

    /* Recientes: lista compacta */
    .rbcloud_recenttracks .rbcloud_recent_track{
      display:block !important;
      margin:0 !important;
      padding:6px 0 !important;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .rbcloud_recenttracks .rbcloud_recent_track:last-child{
      border-bottom:0;
    }
    .rbcloud_recent_artist{
      font-weight:900 !important;
      font-size:12px !important;
      line-height:1.15 !important;
    }
    .rbcloud_recent_title{
      font-size:12px !important;
      opacity:.92 !important;
      line-height:1.15 !important;
      margin-top:2px;
    }

    /* Estado */
    .status{
      margin-top:8px;
      font-size:12px;
      opacity:.7;
    }
    .status.err{
      opacity:1;
      color:#fecaca;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="card">
      <div class="label">Ahora sonando</div>

      <!-- RadioBOSS escribirá aquí (IDs dinámicos) -->
      <div class="rbcloud_nowplaying" style="display:flex;align-items:center;">
        <div style="margin-left:0;">
          <div id="np_artist">Cargando…</div>
          <div id="np_title">—</div>
        </div>
      </div>

      <div id="np_hidden" style="display:none;"></div>
      <div id="np_status" class="status">Inicializando…</div>
    </div>

    <div class="card">
      <div class="label">Recientes (10)</div>

      <!-- RadioBOSS necesita un contenedor con ID rbcloud_recent{widRecent} -->
      <div id="recent_host"></div>

      <div id="rt_status" class="status">Inicializando…</div>
    </div>

  </div>

  <script>
    const p = new URLSearchParams(location.search);

    const host = (p.get("host") || "").trim();
    const u = (p.get("u") || "").trim();
    const widNow = (p.get("widNow") || "").trim();
    const widRecent = (p.get("widRecent") || "").trim();
    const tf = (p.get("tf") || "").trim();

    const npStatus = document.getElementById("np_status");
    const rtStatus = document.getElementById("rt_status");

    function inject(src){
      const s = document.createElement("script");
      s.src = src;
      s.async = true;
      s.onerror = () => console.error("No se pudo cargar:", src);
      document.body.appendChild(s);
    }

    function fail(msg){
      npStatus.textContent = msg;
      npStatus.classList.add("err");
      rtStatus.textContent = msg;
      rtStatus.classList.add("err");
    }

    if(!host || !u || !widNow || !widRecent){
      fail('Faltan parámetros. Se requieren: host, u, widNow, widRecent.');
      throw new Error("Missing params");
    }

    // 1) Crear los IDs EXACTOS que nowplaying2.js llena
    const hidden = document.getElementById("np_hidden");

    const a = document.createElement("div");
    a.id = `rbcloud_np_a${widNow}`;
    a.style.fontWeight = "bold";

    const t = document.createElement("div");
    t.id = `rbcloud_np_t${widNow}`;
    t.textContent = "...";

    hidden.appendChild(a);
    hidden.appendChild(t);

    // 2) Crear el contenedor EXACTO para recent.js
    const recent = document.createElement("div");
    recent.className = "rbcloud_recenttracks";
    recent.id = `rbcloud_recent${widRecent}`;
    recent.setAttribute("data-cnt", "10");
    recent.innerHTML = `
      <div class='rbcloud_recent_track' style='display:flex;align-items:center;margin-bottom:5pt;'>
        <div class='rbcloud_recent_track_cover' data-size='65'></div>
        <div style='margin-left:5pt;'>
          <div class='rbcloud_recent_artist' style='font-weight:bold'></div>
          <div class='rbcloud_recent_title'>...</div>
        </div>
      </div>
    `;
    document.getElementById("recent_host").appendChild(recent);

    // 3) Cargar scripts oficiales
    const tfParam = tf ? `&tf=${encodeURIComponent(tf)}` : "";
    npStatus.textContent = "Cargando Now Playing…";
    rtStatus.textContent = "Cargando Recientes…";

    inject(`${host}/w/nowplaying2.js?u=${encodeURIComponent(u)}&wid=${encodeURIComponent(widNow)}${tfParam}`);
    inject(`${host}/w/recent.js?u=${encodeURIComponent(u)}&wid=${encodeURIComponent(widRecent)}&v=2${tfParam}`);

    // 4) Mostrar en UI el texto que RadioBOSS llena
    function sync(){
      const aa = document.getElementById(`rbcloud_np_a${widNow}`);
      const tt = document.getElementById(`rbcloud_np_t${widNow}`);

      const artist = (aa?.textContent || "").trim();
      const title = (tt?.textContent || "").trim();

      if(artist) document.getElementById("np_artist").textContent = artist;
      if(title && title !== "...") document.getElementById("np_title").textContent = title;

      if(artist || (title && title !== "...")){
        npStatus.textContent = "OK";
      }
      // Para recientes no hay “señal” simple, pero si el DOM crece, asumimos OK:
      const recentEl = document.getElementById(`rbcloud_recent${widRecent}`);
      const items = recentEl ? recentEl.querySelectorAll(".rbcloud_recent_track").length : 0;
      if(items > 1){
        rtStatus.textContent = "OK";
      }
    }

    setInterval(sync, 800);
    setTimeout(sync, 1200);
    setTimeout(() => {
      // Si a los 8s no hay datos, marcamos error
      const artist = document.getElementById("np_artist").textContent.trim();
      if(artist === "Cargando…" || artist === ""){
        npStatus.textContent = "Sin datos (verifica host/u/widNow/widRecent).";
        npStatus.classList.add("err");
      }
    }, 8000);
  </script>
</body>
</html>
