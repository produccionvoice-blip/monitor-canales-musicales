<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RadioBOSS Monitor Widget</title>

  <style>
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      color:#e5e7eb;
      background: transparent;
    }

    .wrap{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px;
    }

    .card{
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      background: rgba(255,255,255,.04);
      padding:12px;
    }

    .label{
      font-size:11px;
      opacity:.75;
      letter-spacing:.6px;
      text-transform: uppercase;
      margin-bottom:10px;
      font-weight:900;
    }

    /* Monitoreo: ocultar carátulas/miniaturas */
    .rbcloud_nowplaying a,
    .rbcloud_nowplaying img,
    .rbcloud_recent_track_cover{
      display:none !important;
    }

    /* Tipografía clara */
    [id^="rbcloud_np_a"]{
      font-weight:900 !important;
      font-size:14px !important;
      line-height:1.15 !important;
    }
    [id^="rbcloud_np_t"]{
      font-size:13px !important;
      opacity:.95 !important;
      line-height:1.15 !important;
      margin-top:2px;
    }

    /* Recientes: lista compacta */
    .rbcloud_recenttracks .rbcloud_recent_track{
      display:block !important;
      margin:0 !important;
      padding:6px 0 !important;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .rbcloud_recenttracks .rbcloud_recent_track:last-child{
      border-bottom:0;
    }
    .rbcloud_recent_artist{
      font-weight:900 !important;
      font-size:12px !important;
      line-height:1.15 !important;
    }
    .rbcloud_recent_title{
      font-size:12px !important;
      opacity:.92 !important;
      line-height:1.15 !important;
      margin-top:2px;
    }

    .status{
      margin-top:8px;
      font-size:12px;
      opacity:.7;
    }
    .status.err{
      opacity:1;
      color:#fecaca;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="card">
      <div class="label">Ahora sonando</div>

      <!-- Estructura OFICIAL (RadioBOSS NowPlaying) -->
      <div class="rbcloud_nowplaying" id="np_container" style="display:flex;align-items:center;">
        <div id="np_cover_slot"></div>

        <div style="margin-left:5pt;">
          <div id="np_artist_slot"></div>
          <div id="np_title_slot">...</div>
        </div>
      </div>

      <div id="np_status" class="status">Inicializando…</div>
    </div>

    <div class="card">
      <div class="label">Recientes (10)</div>

      <!-- Aquí montamos el contenedor OFICIAL de Recents -->
      <div id="recent_mount"></div>

      <div id="rt_status" class="status">Inicializando…</div>
    </div>

  </div>

  <script>
    const p = new URLSearchParams(location.search);

    const host = (p.get("host") || "").trim();
    const u = (p.get("u") || "").trim();
    const widNow = (p.get("widNow") || "").trim();
    const widRecent = (p.get("widRecent") || "").trim();
    const tf = (p.get("tf") || "").trim();

    const npStatus = document.getElementById("np_status");
    const rtStatus = document.getElementById("rt_status");

    function inject(src){
      const s = document.createElement("script");
      s.src = src;
      s.async = true;
      s.onerror = () => {
        npStatus.textContent = "Error cargando scripts de RadioBOSS.";
        npStatus.classList.add("err");
        rtStatus.textContent = "Error cargando scripts de RadioBOSS.";
        rtStatus.classList.add("err");
      };
      document.body.appendChild(s);
    }

    function fail(msg){
      npStatus.textContent = msg;
      npStatus.classList.add("err");
      rtStatus.textContent = msg;
      rtStatus.classList.add("err");
    }

    if(!host || !u || !widNow || !widRecent){
      fail('Faltan parámetros. Se requieren: host, u, widNow, widRecent.');
      throw new Error("Missing params");
    }

    // ---------- NOW PLAYING (estructura oficial completa) ----------
    // Cover (necesario para algunos builds)
    const coverWrap = document.getElementById("np_cover_slot");
    coverWrap.innerHTML = `
      <a target="_blank" href="${host}/w/artwork/${encodeURIComponent(u)}.jpg">
        <img id="rbcloud_np_c${widNow}" src="${host}/w/artwork/${encodeURIComponent(u)}.jpg"
             width="65" height="65" alt="cover art">
      </a>
    `;

    // Artist/Title con IDs EXACTOS que ahora usa nowplaying2.js
    const artistSlot = document.getElementById("np_artist_slot");
    artistSlot.id = `rbcloud_np_a${widNow}`;
    artistSlot.style.fontWeight = "bold";

    const titleSlot = document.getElementById("np_title_slot");
    titleSlot.id = `rbcloud_np_t${widNow}`;
    titleSlot.textContent = "...";

    // ---------- RECENT TRACKS (estructura oficial) ----------
    const recent = document.createElement("div");
    recent.className = "rbcloud_recenttracks";
    recent.id = `rbcloud_recent${widRecent}`;
    recent.setAttribute("data-cnt", "10");

    // Plantilla (RadioBOSS la clona / rellena)
    recent.innerHTML = `
      <div class="rbcloud_recent_track" style="display:flex;align-items:center;margin-bottom:5pt;">
        <div class="rbcloud_recent_track_cover" data-size="65"></div>
        <div style="margin-left:5pt;">
          <div class="rbcloud_recent_artist" style="font-weight:bold"></div>
          <div class="rbcloud_recent_title">...</div>
        </div>
      </div>
    `;

    document.getElementById("recent_mount").appendChild(recent);

    // ---------- Cargar scripts oficiales ----------
    const tfParam = tf ? `&tf=${encodeURIComponent(tf)}` : "";
    npStatus.textContent = "Cargando Now Playing…";
    rtStatus.textContent = "Cargando Recientes…";

    inject(`${host}/w/nowplaying2.js?u=${encodeURIComponent(u)}&wid=${encodeURIComponent(widNow)}${tfParam}`);
    inject(`${host}/w/recent.js?u=${encodeURIComponent(u)}&wid=${encodeURIComponent(widRecent)}&v=2${tfParam}`);

    // ---------- Monitor de estado ----------
    setTimeout(() => {
      const artistEl = document.getElementById(`rbcloud_np_a${widNow}`);
      const titleEl  = document.getElementById(`rbcloud_np_t${widNow}`);

      const artist = (artistEl?.textContent || "").trim();
      const title  = (titleEl?.textContent  || "").trim();

      if (artist || (title && title !== "...")) {
        npStatus.textContent = "OK";
      } else {
        npStatus.textContent = "Sin datos (verifica host/u/widNow).";
        npStatus.classList.add("err");
      }

      const recentEl = document.getElementById(`rbcloud_recent${widRecent}`);
      const items = recentEl ? recentEl.querySelectorAll(".rbcloud_recent_track").length : 0;

      // Si quedan solo 1 template, asumimos no cargó
      if (items > 1) {
        rtStatus.textContent = "OK";
      } else {
        rtStatus.textContent = "Sin datos (verifica host/u/widRecent).";
        rtStatus.classList.add("err");
      }
    }, 5000);
  </script>
</body>
</html>
