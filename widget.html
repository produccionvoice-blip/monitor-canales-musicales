<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RadioBOSS Monitor</title>

  <style>
    body{
      margin:0;
      font-family: Arial, sans-serif;
      color:#e5e7eb;
      background: transparent;
    }
    .wrap{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px;
    }
    .card{
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      background: rgba(255,255,255,.04);
      padding:12px;
    }
    .label{
      font-size:11px;
      opacity:.75;
      letter-spacing:.6px;
      text-transform: uppercase;
      margin-bottom:10px;
      font-weight:700;
    }

    /* NOW PLAYING — prioridad de monitoreo */
    .np{
      display:grid;
      grid-template-columns: 56px 1fr;
      gap:12px;
      align-items:center;
    }
    .np img{
      width:56px;
      height:56px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      object-fit:cover;
      background: rgba(255,255,255,.04);
    }
    .np-artist{
      font-size:14px;
      font-weight:800;
      line-height:1.2;
      margin-bottom:2px;
    }
    .np-title{
      font-size:13px;
      opacity:.9;
      line-height:1.2;
    }

    /* RECENTS — playlist */
    .recent .rbcloud_recent_track{
      display:grid !important;
      grid-template-columns: 32px 1fr;
      gap:10px;
      align-items:center;
      margin: 0 !important;
      padding: 8px 0;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .recent .rbcloud_recent_track:last-child{ border-bottom:0; }
    .recent .rbcloud_recent_track_cover{
      width:32px;
      height:32px;
      border-radius:8px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .recent .rbcloud_recent_artist{
      font-weight:800 !important;
      font-size:12px;
      line-height:1.1;
    }
    .recent .rbcloud_recent_title{
      font-size:12px;
      opacity:.9;
      line-height:1.1;
      margin-top:2px;
    }

    /* Cover grande opcional: lo dejamos oculto por monitoreo */
    .coverBig { display:none; }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- NOW PLAYING -->
    <div class="card">
      <div class="label">Ahora sonando</div>
      <div class="np">
        <a target="_blank" rel="noopener" id="npLink">
          <img id="npCover" alt="cover art">
        </a>
        <div>
          <div class="np-artist" id="npArtist">Cargando…</div>
          <div class="np-title" id="npTitle">Esperando información</div>
        </div>
      </div>
    </div>

    <!-- RECENTS -->
    <div class="card recent" id="recentBox">
      <div class="label">Recientes</div>
      <div class="rbcloud_recenttracks" id="recentRoot" data-cnt="10">
        <div class="rbcloud_recent_track">
          <div class="rbcloud_recent_track_cover" data-size="32"></div>
          <div>
            <div class="rbcloud_recent_artist"></div>
            <div class="rbcloud_recent_title">...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- (Opcional) Carátula grande, desactivada por monitoreo -->
    <div class="card coverBig" id="coverBox">
      <div class="label">Carátula</div>
      <a target="_blank" rel="noopener" id="coverLink">
        <img id="coverImg" width="150" height="150" alt="cover art" />
      </a>
    </div>

  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const host = params.get("host");
    const u = params.get("u");
    const widNow = params.get("widNow");
    const widCover = params.get("widCover");
    const widRecent = params.get("widRecent");
    const tf = params.get("tf");

    function injectScript(src){
      const s = document.createElement("script");
      s.src = src;
      s.async = true;
      document.body.appendChild(s);
    }

    // Setup cover links
    const artworkUrl = `${host}/w/artwork/${u}.jpg`;
    const npLink = document.getElementById("npLink");
    const npCover = document.getElementById("npCover");
    npLink.href = artworkUrl;
    npCover.src = artworkUrl;

    // Optional big cover (hidden)
    const coverLink = document.getElementById("coverLink");
    const coverImg = document.getElementById("coverImg");
    if (coverLink && coverImg) {
      coverLink.href = artworkUrl;
      coverImg.src = artworkUrl;
    }

    // Hidden elements RadioBOSS expects (so the script can populate)
    const hidden = document.createElement("div");
    hidden.style.display = "none";
    hidden.innerHTML = `
      <div id="rbcloud_np_a${widNow}"></div>
      <div id="rbcloud_np_t${widNow}"></div>
      <img id="rbcloud_np_c${widNow}" src="${artworkUrl}" />
      <img id="rbcloud_cover${widCover}" src="${artworkUrl}" />
      <div class="rbcloud_recenttracks" id="rbcloud_recent${widRecent}" data-cnt="10"></div>
    `;
    document.body.appendChild(hidden);

    // Load scripts
    injectScript(`${host}/w/nowplaying2.js?u=${u}&wid=${widNow}${tf ? `&tf=${tf}` : ""}`);
    injectScript(`${host}/w/recent.js?u=${u}&wid=${widRecent}&v=2${tf ? `&tf=${tf}` : ""}`);
    injectScript(`${host}/w/cover.js?u=${u}&wid=${widCover}${tf ? `&tf=${tf}` : ""}`);

    // Mirror to our UI (poll the populated nodes)
    function syncNowPlaying(){
      const a = document.getElementById(`rbcloud_np_a${widNow}`);
      const t = document.getElementById(`rbcloud_np_t${widNow}`);
      const artist = (a && a.textContent || "").trim();
      const title  = (t && t.textContent || "").trim();

      if (artist) document.getElementById("npArtist").textContent = artist;
      if (title && title !== "...") document.getElementById("npTitle").textContent = title;
    }
    setInterval(syncNowPlaying, 800);
    syncNowPlaying();

    // Place recent list in our visible container
    // RadioBOSS will fill #rbcloud_recent{widRecent}, then we copy its children.
    function syncRecents(){
      const src = document.getElementById(`rbcloud_recent${widRecent}`);
      const dst = document.getElementById("recentRoot");
      if (!src || !dst) return;
      if (src.children.length > 0) {
        dst.innerHTML = src.innerHTML;
      }
    }
    setInterval(syncRecents, 1200);
    syncRecents();
  </script>
</body>
</html>
