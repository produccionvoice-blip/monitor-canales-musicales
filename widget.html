<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RadioBOSS Widget</title>

  <style>
    :root{
      --txt:#e5e7eb;
      --muted:rgba(229,231,235,.7);
      --card:rgba(2,6,23,.55);
      --border:rgba(255,255,255,.10);
      --dangerBg:rgba(239,68,68,.12);
      --dangerBd:rgba(239,68,68,.35);
      --dangerTx:#fecaca;
    }
    html,body{margin:0;padding:0;background:transparent;color:var(--txt);font-family:Arial,Helvetica,sans-serif;}
    .wrap{padding:14px;display:flex;flex-direction:column;gap:12px;}
    .box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;}
    .kicker{font-size:12px;letter-spacing:.8px;text-transform:uppercase;color:var(--muted);margin:0 0 8px;}
    .hint{color:var(--muted);font-size:12px;margin-top:8px;}
    .error{background:var(--dangerBg);border:1px solid var(--dangerBd);color:var(--dangerTx);padding:10px;border-radius:12px;font-size:12px;white-space:pre-wrap;}

    /* ==== MONITOREO: ocultar carátulas sin romper RadioBOSS ==== */
    .rbcloud_nowplaying a { display:none !important; }      /* oculta portada en NowPlaying */
    .rbcloud_recent_track_cover { display:none !important; }/* oculta portada en Recientes */

    /* Mejor legibilidad */
    .rbcloud_nowplaying { align-items:flex-start !important; }
    .rbcloud_recenttracks{display:flex;flex-direction:column;gap:10px;}
    .rbcloud_recent_track{
      display:flex;align-items:flex-start;gap:10px;
      padding:8px 10px;border:1px solid rgba(255,255,255,.08);
      border-radius:12px;background:rgba(0,0,0,.10);
    }
    .rbcloud_recent_artist{font-weight:700;font-size:13px;}
    .rbcloud_recent_title{font-size:12px;opacity:.95;word-break:break-word;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="box">
      <p class="kicker">Ahora sonando</p>
      <div id="nowMount"></div>
      <div id="nowHint" class="hint" style="display:none;">Cargando NowPlaying…</div>
    </div>

    <div class="box">
      <p class="kicker">Recientes (10)</p>
      <div id="recentMount"></div>
      <div id="recentHint" class="hint" style="display:none;">Cargando Recientes…</div>
    </div>

    <div id="fatal" class="error" style="display:none;"></div>
  </div>

  <script>
    const qs = (k) => new URLSearchParams(location.search).get(k);
    const id = (qs("id") || "").trim();

    const nowMount = document.getElementById("nowMount");
    const recentMount = document.getElementById("recentMount");
    const nowHint = document.getElementById("nowHint");
    const recentHint = document.getElementById("recentHint");
    const fatal = document.getElementById("fatal");

    function showFatal(msg){
      fatal.style.display = "block";
      fatal.textContent = msg;
    }

    function addScript(src){
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = resolve;
        s.onerror = () => reject(new Error("No se pudo cargar: " + src));
        document.body.appendChild(s);
      });
    }

    async function main(){
      if(!id){
        showFatal("Falta ?id= en widget.html (ej: /widget.html?id=amarilo)");
        return;
      }

      let channels;
      try{
        const res = await fetch(`/channels.json?v=${Date.now()}`, { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        channels = await res.json();
      }catch(e){
        showFatal("No se pudo leer /channels.json: " + e.message);
        return;
      }

      const ch = channels.find(c => c.id === id);
      if(!ch){
        showFatal(`No existe el cliente id="${id}" en channels.json`);
        return;
      }

      const widNow = ch.now?.wid;
      const nowScript = ch.now?.script;
      const artworkNow = ch.now?.artwork || "";

      const widRecent = ch.recent?.wid;
      const recentScript = ch.recent?.script;
      const cnt = ch.recent?.count || 10;

      if(!widNow || !nowScript){
        showFatal("Faltan datos NOW (wid/script) para " + ch.name);
        return;
      }
      if(!widRecent || !recentScript){
        showFatal("Faltan datos RECENT (wid/script) para " + ch.name);
        return;
      }

      /* =========
         NOW PLAYING: HTML EXACTO RadioBOSS
         ========= */
      nowMount.innerHTML = `
<!-- RadioBOSS Cloud NowPlaying Widget (Start) -->
<div class="rbcloud_nowplaying" style="display:flex;align-items:center;">
  <div>
    <a target="_blank" href="${artworkNow}">
      <img id="rbcloud_np_c${widNow}" src="${artworkNow}" width="65" height="65" alt="cover art">
    </a>
  </div>
  <div style="margin-left:5pt;">
    <div id="rbcloud_np_a${widNow}" style="font-weight:bold"></div>
    <div id="rbcloud_np_t${widNow}">...</div>
  </div>
</div>
<!-- RadioBOSS Cloud NowPlaying Widget (End) -->
      `;
      nowHint.style.display = "block";

      /* =========
         RECENT TRACKS: HTML EXACTO RadioBOSS
         ========= */
      recentMount.innerHTML = `
<!-- RadioBOSS Cloud Recent Tracks Widget (Start) -->
<div class="rbcloud_recenttracks" id="rbcloud_recent${widRecent}" data-cnt="${cnt}">
  <div class="rbcloud_recent_track" style="display:flex;align-items:center;margin-bottom:5pt;">
    <div class="rbcloud_recent_track_cover" data-size="0"></div>
    <div style="margin-left:5pt;">
      <div class="rbcloud_recent_artist" style="font-weight:bold"></div>
      <div class="rbcloud_recent_title">...</div>
    </div>
  </div>
</div>
<!-- RadioBOSS Cloud Recent Tracks Widget (End) -->
      `;
      recentHint.style.display = "block";

      /* Cargar scripts (como los entrega RadioBOSS) */
      try { await addScript(nowScript); }
      catch(e){ showFatal("Error cargando NowPlaying script:\n" + e.message); return; }

      try { await addScript(recentScript); }
      catch(e){ showFatal("Error cargando Recent script:\n" + e.message); return; }

      /* Validación: si en 5s no escribió nada, avisamos */
      setTimeout(() => {
        const a = document.getElementById("rbcloud_np_a" + widNow);
        const t = document.getElementById("rbcloud_np_t" + widNow);

        const artist = (a?.textContent || "").trim();
        const title = (t?.textContent || "").trim();

        if(!artist && (!title || title === "...")){
          showFatal(
            "RadioBOSS no escribió datos en el DOM.\n" +
            "Si el stream suena pero aquí no aparece nada, entonces el canal no está enviando metadatos (Artist/Title) o RadioBOSS no tiene historial activo para ese wid.\n\n" +
            "Canal: " + ch.name + "\n" +
            "Now script: " + nowScript + "\n" +
            "Recent script: " + recentScript
          );
        } else {
          nowHint.style.display = "none";
          recentHint.style.display = "none";
        }
      }, 5000);
    }

    main();
  </script>
</body>
</html>
