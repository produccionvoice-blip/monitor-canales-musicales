<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RadioBOSS Widget</title>
  <link rel="stylesheet" href="/styles.css" />
</head>

<body class="widgetBody">
  <div class="clientPanel widgetWrap" id="root"></div>

  <script>
    (function () {
      const root = document.getElementById("root");
      const p = new URLSearchParams(location.search);

      const hostRaw = (p.get("host") || "").trim();
      const u = (p.get("u") || "").trim();
      const widNow = (p.get("widNow") || "").trim();
      const widRecent = (p.get("widRecent") || "").trim();
      const tf = (p.get("tf") || "").trim() === "1";
      const cnt = parseInt(p.get("cnt") || "10", 10);

      const npSize = parseInt(p.get("npSize") || "0", 10);
      const recentSize = parseInt(p.get("recentSize") || "0", 10);

      if (!hostRaw || !u || !widNow || !widRecent) {
        root.innerHTML = `<div class="error">Faltan parámetros: host/u/widNow/widRecent.</div>`;
        return;
      }

      const host = hostRaw.startsWith("http") ? hostRaw : ("https://" + hostRaw.replace(/^\/\//, ""));
      const artwork = `${host}/w/artwork/${encodeURIComponent(u)}.jpg`;

      // === HTML "real" que RadioBOSS espera (IDs y container IDs deben coincidir con wid) ===
      root.innerHTML = `
        <div class="section">
          <div class="sectionTitle">AHORA SONANDO</div>

          <!-- RadioBOSS Cloud NowPlaying Widget (Start) -->
          <div class="rbcloud_nowplaying npRow" style="display:flex;align-items:center;">
            <div class="npCover" style="${npSize === 0 ? "display:none;" : ""}">
              <a target="_blank" href="${artwork}">
                <img
                  id="rbcloud_np_c${widNow}"
                  src="${artwork}"
                  width="${npSize}"
                  height="${npSize}"
                  alt="cover art"
                >
              </a>
            </div>

            <div class="npText" style="margin-left:10px;">
              <div id="rbcloud_np_a${widNow}" class="npArtist" style="font-weight:bold"></div>
              <div id="rbcloud_np_t${widNow}" class="npTitle">...</div>
              <div class="npHint" id="npHint"></div>
            </div>
          </div>
          <!-- RadioBOSS Cloud NowPlaying Widget (End) -->
        </div>

        <div class="section">
          <div class="sectionTitle">RECIENTES (${isNaN(cnt) ? 10 : cnt})</div>

          <!-- RadioBOSS Cloud Recent Tracks Widget (Start) -->
          <div class="rbcloud_recenttracks recentList" id="rbcloud_recent${widRecent}" data-cnt="${isNaN(cnt) ? 10 : cnt}">
            <div class="rbcloud_recent_track recentItem" style="display:flex;align-items:center;margin-bottom:8px;">
              <div class="rbcloud_recent_track_cover" data-size="${recentSize}" style="${recentSize === 0 ? "display:none;" : ""}"></div>
              <div class="recentText" style="margin-left:10px;">
                <div class="rbcloud_recent_artist recentArtist" style="font-weight:bold"></div>
                <div class="rbcloud_recent_title recentTitle">...</div>
              </div>
            </div>
          </div>
          <!-- RadioBOSS Cloud Recent Tracks Widget (End) -->
        </div>
      `;

      // Cargar scripts de RadioBOSS DESPUÉS de crear el HTML
      const nowSrc = `${host}/w/nowplaying2.js?u=${encodeURIComponent(u)}&wid=${encodeURIComponent(widNow)}${tf ? "&tf=1" : ""}`;
      const recSrc = `${host}/w/recent.js?u=${encodeURIComponent(u)}&wid=${encodeURIComponent(widRecent)}&v=2${tf ? "&tf=1" : ""}`;

      const s1 = document.createElement("script");
      s1.src = nowSrc;
      s1.async = true;

      const s2 = document.createElement("script");
      s2.src = recSrc;
      s2.async = true;

      document.body.appendChild(s1);
      document.body.appendChild(s2);

      // Hint suave (sin bloquear): si a los 12s sigue "..." mostramos aviso
      setTimeout(() => {
        const a = document.getElementById(`rbcloud_np_a${widNow}`);
        const t = document.getElementById(`rbcloud_np_t${widNow}`);
        const hint = document.getElementById("npHint");

        const artist = (a?.textContent || "").trim();
        const title = (t?.textContent || "").trim();

        if (!artist && (!title || title === "...")) {
          hint.textContent = "Esperando datos de RadioBOSS...";
        } else {
          hint.textContent = "";
        }
      }, 12000);
    })();
  </script>
</body>
</html>
