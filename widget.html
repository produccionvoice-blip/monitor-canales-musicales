<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RadioBOSS Monitor</title>

  <style>
    :root{
      --text: #e5e7eb;
      --muted: rgba(229,231,235,.78);
      --border: rgba(255,255,255,.10);
      --bgCard: rgba(255,255,255,.04);
    }

    body{
      margin:0;
      font-family: Arial, sans-serif;
      color: var(--text);
      background: transparent;
    }

    .wrap{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px;
    }

    .card{
      border:1px solid var(--border);
      border-radius:12px;
      background: var(--bgCard);
      padding:12px;
    }

    .label{
      font-size:11px;
      opacity:.75;
      letter-spacing:.6px;
      text-transform: uppercase;
      margin-bottom:10px;
      font-weight:800;
    }

    /* ===========================
       NOW PLAYING (texto primero)
       =========================== */
    .np{
      display:grid;
      grid-template-columns: 1fr;
      gap:6px;
    }

    .np-artist{
      font-size:14px;
      font-weight:900;
      line-height:1.2;
      margin:0;
    }

    .np-title{
      font-size:13px;
      opacity:.95;
      line-height:1.25;
      margin:0;
    }

    .np-meta{
      margin-top:6px;
      padding-top:8px;
      border-top:1px solid rgba(255,255,255,.08);
      font-size:11px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* ===========================
       RECENTS (playlist 10 items)
       =========================== */
    .recent .rbcloud_recent_track{
      display:block !important;
      margin: 0 !important;
      padding: 6px 0;            /* compacto para ver más items */
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .recent .rbcloud_recent_track:last-child{ border-bottom:0; }

    /* Ocultamos carátula de recientes para monitoreo */
    .recent .rbcloud_recent_track_cover{
      display:none !important;
    }

    .recent .rbcloud_recent_artist{
      font-weight:900 !important;
      font-size:12px;
      line-height:1.15;
    }

    .recent .rbcloud_recent_title{
      font-size:12px;
      opacity:.92;
      line-height:1.15;
      margin-top:2px;
    }

    /* (Opcional) si RadioBOSS agrega hora/tiempo, lo dejamos discreto */
    .recent .rbcloud_recent_time{
      font-size:11px;
      opacity:.7;
    }

    /* Carátulas: totalmente ocultas (modo monitoreo) */
    .coverBig { display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- NOW PLAYING -->
    <div class="card">
      <div class="label">Ahora sonando</div>

      <!-- Elementos visibles (nuestro UI) -->
      <div class="np">
        <p class="np-artist" id="npArtist">Cargando…</p>
        <p class="np-title" id="npTitle">Esperando información</p>

        <div class="np-meta">
          <span id="npStatus">Estado: Cargando</span>
          <span id="npUpdated">Actualizado: —</span>
        </div>
      </div>

      <!-- Elementos que RadioBOSS llena (ocultos) -->
      <div style="display:none;">
        <div id="rbcloud_np_a__HOLDER"></div>
        <div id="rbcloud_np_t__HOLDER">...</div>
        <img id="rbcloud_np_c__HOLDER" alt="cover art" />
      </div>
    </div>

    <!-- RECENTS -->
    <div class="card recent">
      <div class="label">Recientes (10)</div>

      <!-- Contenedor visible -->
      <div id="recentRoot" class="rbcloud_recenttracks" data-cnt="10">
        <div class="rbcloud_recent_track">
          <div class="rbcloud_recent_artist"></div>
          <div class="rbcloud_recent_title">...</div>
        </div>
      </div>

      <!-- Contenedor oculto que RadioBOSS llena -->
      <div style="display:none;">
        <div class="rbcloud_recenttracks" id="rbcloud_recent__HOLDER" data-cnt="10"></div>
      </div>
    </div>

    <!-- Cover grande (desactivado por monitoreo) -->
    <div class="card coverBig" id="coverBox">
      <div class="label">Carátula</div>
      <a target="_blank" rel="noopener" id="coverLink">
        <img id="coverImg" width="150" height="150" alt="cover art" />
      </a>
    </div>

  </div>

  <script>
    const params = new URLSearchParams(location.search);

    const host = params.get("host");
    const u = params.get("u");
    const widNow = params.get("widNow");
    const widCover = params.get("widCover");
    const widRecent = params.get("widRecent");
    const tf = params.get("tf");

    function injectScript(src){
      const s = document.createElement("script");
      s.src = src;
      s.async = true;
      document.body.appendChild(s);
    }

    // Validación mínima (evita widget en blanco por parámetros faltantes)
    const required = [host, u, widNow, widRecent];
    if (required.some(v => !v)) {
      document.body.innerHTML = "<div style='padding:12px;color:#e5e7eb;font-family:Arial'>Faltan parámetros en widget.html</div>";
      throw new Error("Missing query params");
    }

    // Reemplaza IDs placeholders por IDs reales (para que nowplaying2.js escriba)
    const holderArtist = document.getElementById("rbcloud_np_a__HOLDER");
    const holderTitle  = document.getElementById("rbcloud_np_t__HOLDER");
    const holderCover  = document.getElementById("rbcloud_np_c__HOLDER");
    holderArtist.id = `rbcloud_np_a${widNow}`;
    holderTitle.id  = `rbcloud_np_t${widNow}`;
    holderCover.id  = `rbcloud_np_c${widNow}`;

    const recentHolder = document.getElementById("rbcloud_recent__HOLDER");
    recentHolder.id = `rbcloud_recent${widRecent}`;

    // Scripts RadioBOSS
    injectScript(`${host}/w/nowplaying2.js?u=${u}&wid=${widNow}${tf ? `&tf=${tf}` : ""}`);
    injectScript(`${host}/w/recent.js?u=${u}&wid=${widRecent}&v=2${tf ? `&tf=${tf}` : ""}`);

    // (Cover script no es necesario para monitoreo; lo omitimos)
    // injectScript(`${host}/w/cover.js?u=${u}&wid=${widCover}${tf ? `&tf=${tf}` : ""}`);

    // Sincronización a UI
    let lastText = "";
    let lastUpdateTs = 0;

    function setUpdatedNow() {
      const el = document.getElementById("npUpdated");
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      el.textContent = `Actualizado: ${hh}:${mm}:${ss}`;
    }

    function syncNowPlaying(){
      const a = document.getElementById(`rbcloud_np_a${widNow}`);
      const t = document.getElementById(`rbcloud_np_t${widNow}`);

      const artist = (a && a.textContent || "").trim();
      const title  = (t && t.textContent || "").trim();

      // Si RadioBOSS todavía no cargó
      if (!artist && (!title || title === "..." )) {
        document.getElementById("npStatus").textContent = "Estado: Cargando";
        return;
      }

      if (artist) document.getElementById("npArtist").textContent = artist;
      if (title && title !== "...") document.getElementById("npTitle").textContent = title;

      const combined = `${artist} - ${title}`;
      if (combined !== lastText) {
        lastText = combined;
        lastUpdateTs = Date.now();
        setUpdatedNow();
      }

      // Estado simple: activo si hay texto
      document.getElementById("npStatus").textContent = "Estado: Activo";
    }

    function syncRecents(){
      const src = document.getElementById(`rbcloud_recent${widRecent}`);
      const dst = document.getElementById("recentRoot");
      if (!src || !dst) return;

      // Cuando RadioBOSS llena el contenedor, copiamos al visible
      if (src.innerHTML && src.innerHTML.trim().length > 0) {
        dst.innerHTML = src.innerHTML;

        // Monitoreo: aseguramos que no se vean covers (por si vienen)
        dst.querySelectorAll(".rbcloud_recent_track_cover").forEach(el => {
          el.style.display = "none";
        });
      }
    }

    // Polling (suficiente para monitoreo)
    setInterval(syncNowPlaying, 800);
    setInterval(syncRecents, 1200);

    // Primera ejecución
    syncNowPlaying();
    syncRecents();
  </script>
</body>
</html>
