<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RadioBOSS Widget</title>

  <style>
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      color:#e5e7eb;
      background: transparent;
    }
    .wrap{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px;
    }
    .card{
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      background: rgba(255,255,255,.04);
      padding:12px;
    }
    .label{
      font-size:11px;
      opacity:.75;
      letter-spacing:.6px;
      text-transform: uppercase;
      margin-bottom:10px;
      font-weight:900;
    }

    /* Monitoreo: ocultamos carátulas pero dejamos la estructura para que el script pinte datos */
    .rbcloud_nowplaying a,
    .rbcloud_nowplaying img,
    .rbcloud_recent_track_cover{
      display:none !important;
    }

    /* Now playing */
    [id^="rbcloud_np_a"]{
      font-weight:900 !important;
      font-size:14px !important;
      line-height:1.15 !important;
    }
    [id^="rbcloud_np_t"]{
      font-size:13px !important;
      opacity:.95 !important;
      line-height:1.15 !important;
      margin-top:2px;
    }

    /* Recent list compacta */
    .rbcloud_recenttracks .rbcloud_recent_track{
      display:block !important;
      margin:0 !important;
      padding:6px 0 !important;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .rbcloud_recenttracks .rbcloud_recent_track:last-child{
      border-bottom:0;
    }
    .rbcloud_recent_artist{
      font-weight:900 !important;
      font-size:12px !important;
      line-height:1.15 !important;
    }
    .rbcloud_recent_title{
      font-size:12px !important;
      opacity:.92 !important;
      line-height:1.15 !important;
      margin-top:2px;
    }

    .status{
      margin-top:8px;
      font-size:12px;
      opacity:.7;
    }
    .status.err{
      opacity:1;
      color:#fecaca;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="label">Ahora sonando</div>
      <div id="nowPlayingMount"></div>
      <div id="np_status" class="status">Inicializando…</div>
    </div>

    <div class="card">
      <div class="label">Recientes (10)</div>
      <div id="recentMount"></div>
      <div id="rt_status" class="status">Inicializando…</div>
    </div>
  </div>

  <script>
    const p = new URLSearchParams(location.search);

    const hostRaw = (p.get("host") || "").trim();
    const u = (p.get("u") || "").trim();
    const widNow = (p.get("widNow") || "").trim();
    const widRecent = (p.get("widRecent") || "").trim();
    const tf = (p.get("tf") || "").trim();

    const npStatus = document.getElementById("np_status");
    const rtStatus = document.getElementById("rt_status");

    function fail(msg){
      npStatus.textContent = msg;
      npStatus.classList.add("err");
      rtStatus.textContent = msg;
      rtStatus.classList.add("err");
    }

    let host;
    try{
      const url = new URL(hostRaw);
      if(url.protocol !== "https:") throw new Error("Host debe ser https");
      host = url.origin; // https://c9.radioboss.fm
    }catch(e){
      fail("Host inválido. Debe ser algo como https://c9.radioboss.fm");
      throw e;
    }

    if(!u || !widNow || !widRecent){
      fail("Faltan parámetros: u, widNow o widRecent.");
      throw new Error("Missing params");
    }

    // NOW PLAYING (estructura exacta esperada por nowplaying2.js)
    document.getElementById("nowPlayingMount").innerHTML = `
      <div class="rbcloud_nowplaying" style="display:flex;align-items:center;">
        <div>
          <a target="_blank" href="${host}/w/artwork/${encodeURIComponent(u)}.jpg">
            <img id="rbcloud_np_c${widNow}"
                 src="${host}/w/artwork/${encodeURIComponent(u)}.jpg"
                 width="65" height="65" alt="cover art">
          </a>
        </div>
        <div style="margin-left:5pt;">
          <div id="rbcloud_np_a${widNow}" style="font-weight:bold"></div>
          <div id="rbcloud_np_t${widNow}">...</div>
        </div>
      </div>
    `;

    // RECENT (estructura exacta esperada por recent.js)
    document.getElementById("recentMount").innerHTML = `
      <div class="rbcloud_recenttracks" id="rbcloud_recent${widRecent}" data-cnt="10">
        <div class="rbcloud_recent_track" style="display:flex;align-items:center;margin-bottom:5pt;">
          <div class="rbcloud_recent_track_cover" data-size="0"></div>
          <div style="margin-left:5pt;">
            <div class="rbcloud_recent_artist" style="font-weight:bold"></div>
            <div class="rbcloud_recent_title">...</div>
          </div>
        </div>
      </div>
    `;

    const tfParam = tf ? `&tf=${encodeURIComponent(tf)}` : "";

    function inject(src){
      const s = document.createElement("script");
      s.src = src;
      s.async = true;
      s.onerror = () => fail("Error cargando scripts de RadioBOSS (bloqueo o URL incorrecta).");
      document.body.appendChild(s);
    }

    npStatus.textContent = "Cargando Now Playing…";
    rtStatus.textContent = "Cargando Recientes…";

    inject(`${host}/w/nowplaying2.js?u=${encodeURIComponent(u)}&wid=${encodeURIComponent(widNow)}${tfParam}`);
    inject(`${host}/w/recent.js?u=${encodeURIComponent(u)}&wid=${encodeURIComponent(widRecent)}&v=2${tfParam}`);

    // Verificación para mostrar OK/ERROR
    setTimeout(() => {
      const artist = (document.getElementById(`rbcloud_np_a${widNow}`)?.textContent || "").trim();
      const title  = (document.getElementById(`rbcloud_np_t${widNow}`)?.textContent || "").trim();

      if (artist || (title && title !== "...")) {
        npStatus.textContent = "OK";
      } else {
        npStatus.textContent = "Sin datos (verifica host/u/widNow).";
        npStatus.classList.add("err");
      }

      const recentEl = document.getElementById(`rbcloud_recent${widRecent}`);
      const tracks = recentEl ? recentEl.querySelectorAll(".rbcloud_recent_track").length : 0;

      if (tracks > 1) {
        rtStatus.textContent = "OK";
      } else {
        rtStatus.textContent = "Sin datos (verifica host/u/widRecent).";
        rtStatus.classList.add("err");
      }
    }, 5000);
  </script>
</body>
</html>
