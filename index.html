<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="Monitoreo de canales de música por streaming - Musicar S.A.S." />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#0b1220" />

    <!-- CSP: permite cargar recursos de radioboss y, además, embeber el Page URL en iframe -->
    <meta
      http-equiv="Content-Security-Policy"
      content="
        default-src 'self';
        base-uri 'self';
        object-src 'none';
        frame-ancestors 'none';
        upgrade-insecure-requests;

        img-src 'self' data: https://*.radioboss.fm;
        media-src https:;
        script-src 'self' 'unsafe-inline' https://*.radioboss.fm;
        style-src 'self' 'unsafe-inline';
        connect-src 'self' https://*.radioboss.fm;

        frame-src https://*.radioboss.fm;
        child-src https://*.radioboss.fm;
      "
    />

    <link rel="stylesheet" href="./styles.css" />

    <link rel="preconnect" href="https://c38.radioboss.fm" crossorigin />
    <link rel="preconnect" href="https://c9.radioboss.fm" crossorigin />
    <link rel="preconnect" href="https://c11.radioboss.fm" crossorigin />
    <link rel="preconnect" href="https://c15.radioboss.fm" crossorigin />

    <title>Monitoreo Streaming | Musicar S.A.S.</title>

    <style>
      .rbFrameWrap{ padding: 16px; }
      .rbFrame{
        width: 100%;
        height: min(78vh, 820px);
        border: 1px solid rgba(255,255,255,.10);
        border-radius: 16px;
        background: rgba(0,0,0,.06);
      }
      @media (prefers-color-scheme: light){
        .rbFrame{
          border-color: rgba(0,0,0,.10);
          background: rgba(0,0,0,.03);
        }
      }
      .rbFrameActions{
        display:flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 12px;
        align-items:center;
      }
      .rbHint{
        margin-top: 10px;
        color: rgba(255,255,255,.68);
        font-size: 12.5px;
      }
      @media (prefers-color-scheme: light){
        .rbHint{ color: rgba(0,0,0,.60); }
      }
    </style>
  </head>

  <body>
    <a class="skip-link" href="#main">Saltar al contenido principal</a>

    <header class="topbar">
      <div class="container topbar__inner">
        <div class="brand brand--center">
          <img class="brand__logo brand__logo--lg" src="./Logo_Musicar.png" alt="Musicar S.A.S." />
          <div class="brand__text brand__text--center">
            <div class="brand__title">Monitoreo de Canales</div>
            <div class="brand__subtitle">Musicar – Conecta los Sentidos</div>
          </div>
        </div>

        <div class="topbar__meta topbar__meta--center" id="topMeta" aria-live="polite"></div>
      </div>
    </header>

    <main id="main" class="container">
      <!-- Home -->
      <section id="viewHome" class="panel" hidden>
        <div class="panel__header">
          <h1 class="h1">Canales</h1>
          <p class="muted">
            Busca por nombre del canal y selecciona uno para ver el panel de RadioBOSS (reproductor + reproducción actual + lo que ha sonado).
          </p>
        </div>

        <div class="toolbar">
          <label class="search" for="searchInput">
            <span class="search__icon" aria-hidden="true">⌕</span>
            <input
              id="searchInput"
              type="search"
              inputmode="search"
              autocomplete="off"
              placeholder="Buscar canal…"
              aria-label="Buscar canal por nombre"
            />
          </label>

          <div class="toolbar__right">
            <button class="btn btn--ghost" id="btnReload" type="button" title="Recargar configuración">Recargar</button>
          </div>
        </div>

        <div id="channelsGrid" class="grid" aria-live="polite"></div>
      </section>

      <!-- Canal -->
      <section id="viewChannel" class="panel" hidden>
        <div class="breadcrumb">
          <button class="btn btn--ghost" id="btnBack" type="button">← Volver</button>
          <div class="breadcrumb__sep" aria-hidden="true">/</div>
          <div class="breadcrumb__current" id="channelTitle" aria-live="polite"></div>
        </div>

        <div class="channelLayout">
          <section class="card card--full">
            <div class="card__header">
              <h2 class="h2">Panel del Canal</h2>
            </div>

            <div class="rbFrameWrap">
              <iframe
                id="rbFrame"
                class="rbFrame"
                title="Panel RadioBOSS"
                loading="lazy"
                referrerpolicy="strict-origin-when-cross-origin"
                sandbox="allow-scripts allow-forms allow-same-origin allow-popups"
              ></iframe>

              <div class="rbFrameActions">
                <a id="rbOpen" class="btn btn--primary" href="#" target="_blank" rel="noopener noreferrer">
                  Abrir panel de RadioBOSS
                </a>
                <button class="btn btn--ghost" id="rbReload" type="button" title="Recargar panel">
                  Recargar panel
                </button>
              </div>

              <div class="rbHint" id="rbHint">
                Si el panel no aparece dentro de la página, es posible que RadioBOSS bloquee el uso en iframe. En ese caso usa “Abrir panel de RadioBOSS”.
              </div>
            </div>
          </section>
        </div>
      </section>

      <!-- Error -->
      <section id="viewError" class="panel" hidden>
        <div class="panel__header">
          <h1 class="h1">No fue posible cargar la configuración</h1>
          <p class="muted" id="errorText"></p>
        </div>
        <div class="panel__footer">
          <button class="btn btn--primary" id="btnRetry" type="button">Reintentar</button>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="container footer__inner">
        <div class="muted">Musicar S.A.S. • Monitoreo de Streaming • <span id="year"></span></div>
      </div>
    </footer>

    <script>
      (function () {
        "use strict";

        const FILE_CHANNELS = "./channels.json";
        const FILE_STREAMS = "./streams.json"; // se mantiene (opcional / compatibilidad)

        const el = (id) => document.getElementById(id);

        const viewHome = el("viewHome");
        const viewChannel = el("viewChannel");
        const viewError = el("viewError");

        const channelsGrid = el("channelsGrid");
        const searchInput = el("searchInput");
        const btnReload = el("btnReload");
        const btnRetry = el("btnRetry");
        const btnBack = el("btnBack");

        const channelTitle = el("channelTitle");
        const topMeta = el("topMeta");

        const rbFrame = el("rbFrame");
        const rbOpen = el("rbOpen");
        const rbReload = el("rbReload");
        const rbHint = el("rbHint");

        el("year").textContent = String(new Date().getFullYear());

        let state = {
          channels: [],
          streams: [],
          merged: []
        };

        function normalizeText(s) {
          return (s || "")
            .toString()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .trim();
        }

        function showOnly(which) {
          viewHome.hidden = which !== "home";
          viewChannel.hidden = which !== "channel";
          viewError.hidden = which !== "error";
        }

        function setTopMeta(text) {
          topMeta.textContent = text || "";
        }

        function parseQuery() {
          const qs = new URLSearchParams(window.location.search);
          return qs.get("c") || qs.get("channel") || "";
        }

        function setQueryChannel(nameOrEmpty) {
          const url = new URL(window.location.href);
          if (!nameOrEmpty) {
            url.searchParams.delete("c");
            url.searchParams.delete("channel");
          } else {
            url.searchParams.set("c", nameOrEmpty);
            url.searchParams.delete("channel");
          }
          window.history.pushState({}, "", url.toString());
        }

        async function loadJson(url) {
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`Error HTTP ${res.status} al cargar ${url}`);
          return res.json();
        }

        async function loadConfig() {
          setTopMeta("Cargando configuración…");
          showOnly("home");
          viewHome.hidden = true;

          try {
            const channelsData = await loadJson(FILE_CHANNELS);

            // streams.json es opcional (no bloquea si falta)
            const streamsData = await loadJson(FILE_STREAMS).catch(() => ({ streams: [] }));

            const channels = Array.isArray(channelsData.channels) ? channelsData.channels : [];
            const streams = Array.isArray(streamsData.streams) ? streamsData.streams : [];

            const mapStream = new Map(streams.map((s) => [s.name, s.streamUrl]));
            const merged = channels.map((ch) => ({
              ...ch,
              streamUrl: mapStream.get(ch.name) || ""
            }));

            state = { channels, streams, merged };

            setTopMeta(`Configuración cargada • ${state.merged.length} canales`);
            route();
          } catch (err) {
            console.error(err);
            el("errorText").textContent =
              "No se pudieron cargar los archivos de configuración (channels.json / streams.json). " +
              "Verifica que existan en la raíz del proyecto y que el despliegue los esté sirviendo correctamente.";
            showOnly("error");
            setTopMeta("Error de carga");
          }
        }

        function createChannelCard(ch) {
          const a = document.createElement("a");
          a.className = "cardLink";
          a.href = `?c=${encodeURIComponent(ch.name)}`;
          a.setAttribute("role", "listitem");

          a.addEventListener("click", (e) => {
            e.preventDefault();
            setQueryChannel(ch.name);
            renderChannel(ch.name);
          });

          const title = document.createElement("div");
          title.className = "cardLink__title";
          title.textContent = ch.name;

          const meta = document.createElement("div");
          meta.className = "cardLink__meta";
          meta.textContent = ch.pageUrl ? "Panel RadioBOSS disponible" : "Panel no configurado";

          a.appendChild(title);
          a.appendChild(meta);
          return a;
        }

        function renderHome() {
          showOnly("home");

          channelsGrid.innerHTML = "";
          channelsGrid.setAttribute("role", "list");

          const query = normalizeText(searchInput.value);
          const list = state.merged
            .filter((c) => normalizeText(c.name).includes(query))
            .sort((a, b) => a.name.localeCompare(b.name, "es"));

          if (list.length === 0) {
            const empty = document.createElement("div");
            empty.className = "empty";
            empty.innerHTML = "<strong>No hay resultados.</strong><div class='muted'>Ajusta el filtro de búsqueda.</div>";
            channelsGrid.appendChild(empty);
            return;
          }

          for (const ch of list) channelsGrid.appendChild(createChannelCard(ch));
        }

        function setFrame(url) {
          rbFrame.src = url || "about:blank";
          rbOpen.href = url || "#";
          rbOpen.setAttribute("aria-disabled", url ? "false" : "true");
        }

        function renderChannel(name) {
          const ch = state.merged.find((c) => c.name === name);
          if (!ch) {
            setQueryChannel("");
            renderHome();
            return;
          }

          showOnly("channel");
          channelTitle.textContent = ch.name;
          document.title = `${ch.name} | Monitoreo Streaming | Musicar S.A.S.`;

          if (!ch.pageUrl) {
            setTopMeta(`Canal seleccionado: ${ch.name} (sin Page URL)`);
            rbHint.textContent =
              "Este canal no tiene Page URL configurada en channels.json. Agrega pageUrl con la ruta /u/xxx de RadioBOSS.";
            setFrame("");
            return;
          }

          setTopMeta(`Canal seleccionado: ${ch.name}`);
          rbHint.textContent =
            "Si el panel no aparece dentro de la página, es posible que RadioBOSS bloquee el uso en iframe. En ese caso usa “Abrir panel de RadioBOSS”.";

          setFrame(ch.pageUrl);
        }

        function route() {
          const c = parseQuery();
          if (c) renderChannel(c);
          else renderHome();
        }

        // Eventos
        searchInput.addEventListener("input", () => renderHome());
        btnReload.addEventListener("click", () => loadConfig());
        btnRetry.addEventListener("click", () => loadConfig());

        btnBack.addEventListener("click", () => {
          setFrame("");
          setQueryChannel("");
          document.title = "Monitoreo Streaming | Musicar S.A.S.";
          setTopMeta(`Configuración cargada • ${state.merged.length} canales`);
          renderHome();
        });

        rbReload.addEventListener("click", () => {
          const current = rbFrame.src;
          if (!current || current === "about:blank") return;
          rbFrame.src = "about:blank";
          setTimeout(() => (rbFrame.src = current), 50);
        });

        window.addEventListener("popstate", () => route());

        // Init
        loadConfig();
      })();
    </script>
  </body>
</html>
